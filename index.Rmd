---
title: "Portfolio Computational Musicology"
author: "Femke van Boheemen"
date: "March 2022"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    theme: simplex
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(spotifyr)
library(compmus)
library(dplyr)
library(ggplot2)
library(plotly)
library(Cairo)
```



### Week 11: Tempograms

```{r week 11, echo=FALSE, fig.show="hold", out.width="50%"}


blacklist <- get_tidy_audio_analysis("3iUJrkMilUVkUKtYZK7Th4")

blacklist %>%
  tempogram(window_size = 8, hop_size = 1, cyclic = FALSE) %>%
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none") +
  labs(x = "Time (s)", y = "Tempo (BPM)", title = "Tempogram of 'Blacklist' by Exodus") +
  theme_classic()

archangel <- get_tidy_audio_analysis("63aGgWIoGfl3wxykzje8eJ")

archangel %>%
  tempogram(window_size = 8, hop_size = 1, cyclic = TRUE) %>%
  ggplot(aes(x = time, y = bpm, fill = power)) +
  geom_raster() +
  scale_fill_viridis_c(guide = "none") +
  labs(x = "Time (s)", y = "Tempo (BPM)", title = "Cyclic tempogram of 'Archangel' by Amaranthe") +
  theme_classic()

```

***

<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/3iUJrkMilUVkUKtYZK7Th4?utm_source=generator" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>

<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/63aGgWIoGfl3wxykzje8eJ?utm_source=generator" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>

***
What you see here are two tempograms of songs that I consider to be archetypes of my playlists. They both appear in my playlist as well as Spotify’s. For the first song, ‘Blacklist’ by Exodus, I chose to display the normal tempogram and not the cyclic one because even though the cyclic tempogram is more accurate, the normal one is much clearer. Besides, you only have to halve the outcome of this tempogram to get the right BPM. According to the internet, the correct BPM of Blacklist is 150, which is also vaguely visible in this tempogram. The most notable thing here is probably the large beam where the tempo seams really distorted. This has the exact duration of the solo in the song, which probably makes it hard for spotify to determine the correct BPM. Near the end is another very small distortion which I can’t really explain. I do think it is interesting to see how the ‘line’ at 150 BPM is more prominent at times in the song where it seems they’re leaving out some eighth notes the main riff so it feels like half. This is not really true though, the drums still do the same thing.

The second tempogram is of ‘Archangel’ by Amaranthe for which I chose to display a cyclic one. This was just way more accurate and just a little less clear. The BPM of this song is 90, says the internet, so Spotify also did a good job here. The weird distortion can be explained by the part after the solo/bridge in which there are no guitars or constant drums. This part is entirely different from the rest of the song and functions as a kind of pause so it’s logical there is no vast tempo. 

It is very interesting to see that both these songs have a very steady tempo with a small distortion at the solo or bridge. The weird part is that they have such a difference in BPM-value. I think this is because heavy metal songs get their energy from their constant tempo and beat, which is why almost every time the value is doubled or tripled in the case of Archangel. It seems the actual value of the tempo does not really matter as both these songs are ranked quite high in energy. 


### Week 10: Key and chord estimation

```{r week 10, echo=FALSE, fig.show="hold", out.width="50%"}

circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )

key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )

trooper <-
  get_tidy_audio_analysis("4OROzZUy6gOWN4UGQVaZMF") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

trooper %>% 
  compmus_match_pitch_template(
    key_templates,         
    method = "euclidean",  
    norm = "manhattan"     
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "", title = "Chordogram of 'The trooper' by Iron Maiden")

maximus <-
  get_tidy_audio_analysis("1K39nmA9tBudF6jNiV1iO6") %>%
  compmus_align(sections, segments) %>%
  select(sections) %>%
  unnest(sections) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "mean", norm = "manhattan"
      )
  )

maximus %>% 
  compmus_match_pitch_template(
    key_templates,         
    method = "euclidean",  
    norm = "manhattan"     
  ) %>%
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none") +
  theme_minimal() +
  labs(x = "Time (s)", y = "", title = "Chordogram of 'Maximus' by Warkings")


```

***
<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/4OROzZUy6gOWN4UGQVaZMF?utm_source=generator" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>

<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/1K39nmA9tBudF6jNiV1iO6?utm_source=generator" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>

***
commentaar

### Week 9: Cepstrograms and Self-Similarity Matrices

```{r week 9, echo=FALSE, fig.show="hold", out.width="50%"}

Painkiller <-
  get_tidy_audio_analysis("0L7zm6afBEtrNKo6C6Gj08") %>% 
  compmus_align(bars, segments) %>%                 
  select(bars) %>%                                  
  unnest(bars) %>%                                  
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"          
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"          
      )
  )

Painkiller %>%
  compmus_gather_timbre() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  scale_fill_viridis_c() +                              
  theme_classic()

Demons <-
  get_tidy_audio_analysis("2JwQ5NZzqLYyKEKJhfsItN") %>% 
  compmus_align(bars, segments) %>%                 
  select(bars) %>%                                  
  unnest(bars) %>%                                  
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"          
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"          
      )
  )

Demons %>%
  compmus_gather_timbre() %>%
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  scale_fill_viridis_c() +                              
  theme_classic()

Painkiller %>%
  compmus_self_similarity(timbre, "cosine") %>% 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")

```

***
<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/0L7zm6afBEtrNKo6C6Gj08?utm_source=generator" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>


<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/2JwQ5NZzqLYyKEKJhfsItN?utm_source=generator" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>

***
commentaar

### Week 8: Chromagrams

```{r week 8, echo=FALSE, fig.show="hold", out.width="50%"}

Overthewall <-
  get_tidy_audio_analysis("5xXeIlEiWIA8xnPa8BkJyj") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

Overthewall %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Chromagram of 'Over the wall' by Testament") +
  theme_minimal() +
  scale_fill_viridis_c()


Becoming <-
  get_tidy_audio_analysis("6grZ25M9c5o8T75z0tY0xq") %>%
  select(segments) %>%
  unnest(segments) %>%
  select(start, duration, pitches)

Becoming %>%
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) %>%
  compmus_gather_chroma() %>% 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Chromagram of 'Becoming' by Volbeat") +
  theme_minimal() +
  scale_fill_viridis_c()

compmus_long_distance(
  Overthewall %>% mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  Becoming %>% mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  feature = pitches,
  method = "euclidean"
) %>%
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  labs(x = "Over the wall", y = "Becoming", title = "Chromagram of 'Becoming' versus 'Over the Wall'") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)

```

***
<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/5xXeIlEiWIA8xnPa8BkJyj?utm_source=generator" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>

<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/6grZ25M9c5o8T75z0tY0xq?utm_source=generator" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>

***
commentaar


### Week 7: Audio visualisation

```{r week 7, echo=FALSE, fig.show="hold", out.width="50%"}

femke <- get_playlist_audio_features("", "0xKB9peSIoqMIexrmubkV3")
spotify <- get_playlist_audio_features("", "37i9dQZF1DX9qNs32fujYe")

playlists <-
  bind_rows(
    femke %>% mutate(category = "Femke"),
    spotify %>% mutate(category = "Spotify")
  )

playlistsplot <- playlists %>%
  mutate(
    mode = ifelse(mode==0, "Minor", "Major")
    ) %>%
  ggplot(
    aes(
      x = energy,
      y = tempo,
      size = instrumentalness,
      colour = mode
    )
  ) +
  geom_point(alpha = 0.65
  ) +
  geom_rug(size = 0.1) +
  geom_text(
    aes(
      x = energy,
      y = tempo,
      label = label
    ),
    data =
      tibble(
        label = c("geen idee", "energy"),
        category = c("Femke", "Spotify"),
        tempo = c(0.090, 0.123),
        energy = c(0.101, 0.967)
      ),
    colour = "black",
    size = 3,
    hjust = "left",
    vjust = "bottom",
    nudge_x = -0.05,
    nudge_y = 0.02,
  ) +
  facet_wrap(~category) +
  scale_y_continuous(
    limits = c(50, 210),
    breaks = c(50, 100, 150, 200),
    minor_breaks = NULL
  ) +
    scale_x_continuous(
    limits = c(0.3, 1),
    breaks = c(0.3, 0.50, 1),
    minor_breaks = NULL
    ) +
  scale_colour_brewer(
     type = "qual",
      palette = "Set2",
     ) +
    scale_size_continuous(      
    trans = "exp",
    guide = "bins"
  ) +
  theme_light() +            
  labs(                       
    x = "Energy",
    y = "Tempo",
    colour = "Mode",
    size = "Instrumentalness",
    title = "Energy, tempo, instrumentalness and mode of Femke's and Spotify's playlists"
  )

ggplotly(playlistsplot)

```

***
commentaar

### Week 6: Introduction to my corpus

For my corpus, I will be using two playlist made specifically of heavy metal songs. One of those was made by me around a year ago and the other is made by Spotify itself. I’m interested in the difference between the musical elements of each playlist. I wonder if my perception of ‘heavy metal’ will be the same as Spotify’s and what exactly the differences are. In this corpus I’m comparing the musical elements that Spotify gives me of the two playlists. I think there will be some differences, my playlist will likely be a bit ‘heavier’, or just more extreme, but overall I think the proportions will be mainly the same. The tracks in the Spotify playlist are quite representative of the the heavy metal genre, although there might be some outliers. I do think that my own playlist might be a bit less representative, but that is what I’m trying to find out, how close I am to the actual genre. There are no typical tracks on either of the playlists that I am using. However, there are some artists that return regularly. In my own playlist they are Judas Priest, Iron Maiden and Testament, and in the Spotify playlist they are Powerwolf, Volbeat and Warkings. There are some songs that appear in both playlists: Archangel - Amaranthe, Raise your horns - Amon Amarth, A statue of the king - Avatar, The book of heavy metal - Dream evil and Blacklist - Exodus. The corresponding artist are: Amaranthe, Amon Amarth, Arch Enemy, Avatar, Dream Evil, Exodus, Gojira, Iron Maiden, Judas Priest, Machine Head, Mastodon, Metallica, Sabaton and Upon a burning body.

***
The playlists I will be using in this research, first my own and second the one by Spotify:

***

<iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/0xKB9peSIoqMIexrmubkV3?utm_source=generator" width="100%" height="380" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>

<iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/37i9dQZF1DX9qNs32fujYe?utm_source=generator" width="100%" height="380" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>

